<!doctype html>
<title>Notorious A.P.I.</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="favicon.png">

<link href='css/index.css' rel='stylesheet' type='text/css'>

<script src="js/seedrandom.js"></script>
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/d3.min.js"></script>
<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/app.js"></script>

<script src="js/jquery.nouislider.min.js"></script>
<script src="js/howler.min.js"></script>
<script src="js/jquery.tagsinput.js"></script>

<script>
  var global_mute = false;
  var global_volume = 50;
  var TAG_FILTERS = [];
  var DEBUG = false;

  $(function(){
    Howler.volume(global_volume * .01);
    $('#volumeControl').click(function() {
      if (!global_mute) {
        global_mute = false;
        Howler.mute();
        $('#volumeControl').css('background-position', '0 0');
      } else {
        global_mute = false;
        Howler.unmute();
        $('#volumeControl').css('background-position', '0 -46px');
      }
    });

    $('#volumeSlider').noUiSlider({
      range : [-99, 0],
      start : 0,
      handles : 1,
      step : 1,
      orientation : 'horizontal',
      slide : function() {
        global_volume = 100 + $(this).val();
        var howler_volume = global_volume * 0.01;
        if (howler_volume <= 0.01) {
          Howler.mute();
        } else {
          Howler.unmute();
          Howler.volume(global_volume * .01);
        }
    }});
  });

  /* Settings
     ======== */

  var gctx = {};
  var should_connect = false;

  var scale_factor = 5,
      note_overlap = 15,
      note_timeout = 300,
      current_notes = 0,
      max_life = 10000, // NOTE: this transition has been overriden in view.css, so if you want to change the durationâ€”do it there.
      DEFAULT_LANG = 'en';

  /* Colors
     ====== */

  var body_background_color = '#f8f8f8',
      body_text_color = '#000',
      svg_background_color = '#1b0f24',
      svg_text_color = '#fff',
      newuser_box_color = 'rgb(41, 128, 185)',
      bot_color = 'rgb(155, 89, 182)',
      anon_color = 'rgb(46, 204, 113)',
      edit_color = '#fff',
      sound_totals = 51,
      total_edits = 0;

  /* Languages
     ========= */

  var langs = {
    'en': ['English', 'ws://wikimon.hatnote.com:9000'],
    'de': ['German', 'ws://wikimon.hatnote.com:9010'],
    'ru': ['Russian', 'ws://wikimon.hatnote.com:9020'],
    'uk': ['Ukrainian', 'ws://wikimon.hatnote.com:9310'],
    'ja': ['Japanese', 'ws://wikimon.hatnote.com:9030'],
    'es': ['Spanish', 'ws://wikimon.hatnote.com:9040'],
    'fr': ['French', 'ws://wikimon.hatnote.com:9050'],
    'nl': ['Dutch', 'ws://wikimon.hatnote.com:9060'],
    'it': ['Italian', 'ws://wikimon.hatnote.com:9070'],
    'sv': ['Swedish', 'ws://wikimon.hatnote.com:9080'],
    'ar': ['Arabic', 'ws://wikimon.hatnote.com:9090'],
    'fa': ['Farsi', 'ws://wikimon.hatnote.com:9210'],
    'he': ['Hebrew' , 'ws://wikimon.hatnote.com:9230'],
    'id': ['Indonesian', 'ws://wikimon.hatnote.com:9100'],
    'zh': ['Chinese', 'ws://wikimon.hatnote.com:9240'],
    'as': ['Assamese', 'ws://wikimon.hatnote.com:9150'],
    'hi': ['Hindi', 'ws://wikimon.hatnote.com:9140'],
    'bn': ['Bengali', 'ws://wikimon.hatnote.com:9160'],
    'pa': ['Punjabi', 'ws://wikimon.hatnote.com:9120'],
    'te': ['Telugu', 'ws://wikimon.hatnote.com:9165'],
    'ta': ['Tamil', 'ws://wikimon.hatnote.com:9110'],
    'ml': ['Malayalam', 'ws://wikimon.hatnote.com:9250'],
    'mr': ['Western Mari', 'ws://wikimon.hatnote.com:9130'],
    'kn': ['Kannada', 'ws://wikimon.hatnote.com:9170'],
    'or': ['Oriya', 'ws://wikimon.hatnote.com:9180'],
    'sa': ['Sanskrit', 'ws://wikimon.hatnote.com:9190'],
    'gu': ['Gujarati' , 'ws://wikimon.hatnote.com:9200'],
    'pl': ['Polish' , 'ws://wikimon.hatnote.com:9260'],
    'mk': ['Macedonian' , 'ws://wikimon.hatnote.com:9270'],
    'be': ['Belarusian' , 'ws://wikimon.hatnote.com:9280'],
    'sr': ['Serbian' , 'ws://wikimon.hatnote.com:9290'],
    'bg': ['Bulgarian' , 'ws://wikimon.hatnote.com:9300'],
    'hu': ['Hungarian', 'ws://wikimon.hatnote.com:9320'],
    'fi': ['Finnish', 'ws://wikimon.hatnote.com:9330'],
    'no': ['Norwegian', 'ws://wikimon.hatnote.com:9340'],
    'el': ['Greek', 'ws://wikimon.hatnote.com:9350'],
    'eo': ['Esperanto', 'ws://wikimon.hatnote.com:9360'],
    'pt': ['Portuguese', 'ws://wikimon.hatnote.com:9370'],
    'et': ['Estonian', 'ws://wikimon.hatnote.com:9380'],
    'wikidata': ['Wikidata' , 'ws://wikimon.hatnote.com:9220']
  }

  /*
     ============== */

  var w = window,
      d = document,
      e = d.documentElement,
      g = d.getElementsByTagName('.js-view svg')[0],
      width = w.innerWidth || e.clientWidth || g.clientWidth;
      height = w.innerHeight|| e.clientHeight || g.clientHeight;

  var celesta = [],
      clav = [],
      epm = 0,
      edit_times = [],
      SOCKETS = {},
      swells = [],
      all_loaded = false,
      s_titles = true,
      s_welcome = true,
      s_langs = [];

  var user_announcements = false;
  setTimeout(function() {
      user_announcements = true;
  }, 20000);

  $(function(){

    // Chrome 66 Autoplay Policy Compliance
    if (getChromeVersion() >= 66){
      if (Howler.ctx.state == 'suspended') {
        $('.js-view').prepend('<button class="btn md unmute" type="button">Enable Sound</button>');
      }
      $(document).click(function() {
        Howler.ctx.resume().then($('.unmute').fadeOut(150));
        gctx = Howler.ctx;
      });
    }

    $('body').css('background-color', body_background_color)
    $('body').css('color', body_text_color)
    $('svg').css('background-color', svg_background_color)
    $('svg text').css('color', svg_text_color)
    // :(
    $('head').append('<style type="text/css">.newuser-label {fill:' + svg_text_color +
                     ';} .bot {fill:' + bot_color +
                     ';} .anon {fill:' + anon_color +
                     ';} .bot </style>');
    $('body').append('<div id="loading"><p>Loading sound files ...</p></div>')

    var svg = d3.select('.js-view').append('svg');

    // add svg filter
    const defs = svg.append('defs');
    const filter = defs.append('filter').attr('id','glow');
    const feMerge = filter.append('feMerge');

    filter.append('feGaussianBlur').attr('stdDeviation','1.5').attr('result','coloredBlur');
    feMerge.append('feMergeNode').attr('in','coloredBlur');
    feMerge.append('feMergeNode').attr('in','SourceGraphic');
    // end svg filter

    // add svg gradient
    const gradient = defs.append('radialGradient');
    const stop1 = gradient.append('stop');
    const stop2 = gradient.append('stop');

    gradient.attr('id', 'ring');
    stop1.attr('offset', '0');
    stop1.attr('stop-color', 'rgba(133,223,196,1)'); // teal
    stop2.attr('offset', '100%');
    stop2.attr('stop-color', 'rgba(27,15,36,0)'); // purple-dark
    // end svg gradient

    $('#background_mode').click(
      function() {$('.js-view svg').toggle();}
    );
    $('#hide_rc_box').click(
      function() {$('#rc-log').toggle();}
    );

    const testButton = document.querySelector('.test-button');
    testButton.addEventListener('click', () => {
      fakeMessage = {
        "page_title": "Test_Title",
        "url": "http://www.google.com",
        "change_size": Math.floor(Math.random() * 50)
      };
      handle_message(fakeMessage);
    });

    // TODO: Volume slider?
    var loaded_sounds = 0
    var sound_load = function(r) {
      loaded_sounds += 1
      if (loaded_sounds == sound_totals) {
        all_loaded = true
        $('#loading').remove()
        console.log('Loading complete')
      } else {
        // console.log('Loading : ' + loaded_sounds + ' files out of ' + sound_totals)
      }
    }

    // load celesta and clav sounds
    for (var i = 1; i <= 24; i++) {
      if (i > 9) {
        fn = 'c0' + i;
      } else {
        fn = 'c00' + i;
      }
      celesta.push(new Howl({
        urls : ['sounds/celesta/' + fn + '.ogg',
                'sounds/celesta/' + fn + '.mp3'],
        volume : 0.2,
        onload : sound_load(),
      }))
      clav.push(new Howl({
        urls : ['sounds/clav/' + fn + '.ogg',
                'sounds/clav/' + fn + '.mp3'],
        volume : 0.2,
        onload : sound_load(),
      }))
    }

    // load swell sounds
    for (var i = 1; i <= 3; i++) {
      swells.push(new Howl({
        urls : ['sounds/swells/swell' + i + '.ogg',
                'sounds/swells/swell' + i + '.mp3'],
        volume : 1,
        onload : sound_load(),
      }))
    }

    /*
    function testuser() {
        data = {user: 'Slaporte'}
        newuser_action(data, 'en', svg)
    }

    testuser()
    */

    initMessages(svg);

    const connectToggle = document.querySelector('#connectToMQ');
    connectToggle.addEventListener('click', () => {
      handleMQToggle();
    });

    function handleMQToggle() {
      isChecked = $('#connectToMQ').prop('checked');
      console.log(isChecked);
      if (isChecked == true) {
        //Should connect to MQ
        should_connect = true;
        pollMessages();
      }
      else {
        //Should NOT connect to MQ
        should_connect = false;
      }
    };
    handleMQToggle();

    $('#filter').tagsInput({
      height: '45px',
      width: '80%',
      'delimiter': [' ', ','],
      defaultText: 'Add a tag',
      defaultTextWidth: 100,
      unique: false,
      onChange: function() {
        TAG_FILTERS = [];
        $('.tag span').each(function(val) {
          var tag = $(this).text().trim().replace('#', '').toLowerCase();
          if($.inArray(tag, TAG_FILTERS) === -1){
            TAG_FILTERS.push(tag);
          }
        });
        update_tag_warning(svg);
        console.log('Watching for: ' + TAG_FILTERS)
      }
    });
  })
</script>

<section class='view js-view'>
  <footer class="flex align-center justify-justified footer">
    <span class="about-link">
      <span id="volumeWrapper" class="interface">
        <span id="volumeSlider" class="noUiSlider"></span>
      </span>
    </span>
    <div>
      <button class="btn sm test-button" type="button">Test</button>
      <input type="checkbox" name="connectToMQ" id="connectToMQ">
      <label for='connectToMQ'>Connect to MQ</label>
    </div>
  </footer>
</section>

<div id='content'>
    <div class='bg'>
        <div id='rc-log-c'>
            <h3>Recent changes</h3>
            <ul id='rc-log'>
            </ul>
             <div class="note">
              <p id="edit_counter"></p>
              <p>For more, see Wikipedia's RecentChanges pages for <a href="http://www.wikipedia.org/">each language</a>.</p>
            </div>
        </div>
    </div>
</div>
<div class="foot">
    <h3>Settings</h3>
    <p><input type="checkbox" name="welcome" id="welcome">
    <label for='welcome'>Hide new user announcements</label></p>
    <p><input type="checkbox" name="titles" id="titles">
    <label for='titles'>Hide article titles</label></p>
    <p><input type="checkbox" name="hide_rc_box" id="hide_rc_box">
    <label for="hide_rc_box">Hide recent changes console</label></p>
    <p><input type="checkbox" name="background_mode" id="background_mode">
    <label for="background_mode">Hide graphics for background listening</label></p>
    <h3>Languages</h3>
    <div id='lang-boxes'> </div>
    <div class='clear'><br/></div>
    <h3>Tags</h3>
    <p>Listen for edits with a hashtag in the edit summary. Try it yourself! To do this, enter a hashtag below, then go make an edit and the same tag in the <a href="https://en.wikipedia.org/wiki/Help:Edit_summary">edit summary</a> of your article. If you have tags here, you will only hear edits with those tags.</p>
    <p><input id="filter" type="text" value=""></p>
</div>
